name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '30 2 * * 1'  # Weekly security scan

env:
  FLUTTER_VERSION: '3.35.3'
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.14.2'

jobs:
  # =============================================================================
  # ANALYSIS PHASE - Runs in parallel for all pushes/PRs
  # =============================================================================
  
  lint:
    name: ğŸ” Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”§ Create .env file
        run: echo "GOOGLE_MAPS_API_KEY=placeholder" > .env

      - name: ğŸ¨ Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ” Analyse project source
        run: flutter analyze

      - name: ğŸ“ Lint markdown files
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: '**/*.md'

  unit-test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”§ Create .env file
        run: |
          echo "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}" > .env

      - name: ğŸ§ª Run unit tests
        run: flutter test --exclude-tags=benchmark

  benchmark:
    name: ğŸ“Š Benchmark
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”§ Create .env file
        run: echo "GOOGLE_MAPS_API_KEY=test-key-for-benchmarks" > .env

      - name: ğŸ“Š Run benchmark tests
        run: flutter test test/benchmark/ --reporter expanded

      - name: ğŸ“¤ Upload benchmark results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: benchmark-results-${{ github.run_number }}
          path: |
            build/benchmark_results.json
            build/navigation_benchmark_results.json
          retention-days: 30

  security-scan:
    name: ğŸ”’ Security Scan (MobSF)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6
      
      - name: ğŸ Setup Python for MobSF
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      
      - name: ğŸ”’ Run MobSF Security Scan
        uses: MobSF/mobsfscan@main
        with:
          args: '. --sarif --output mobsf-results.sarif || true'
      
      - name: ğŸ“¤ Upload MobSF SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: mobsf-results.sarif
          category: mobsf-security-scan
      
      - name: ğŸ“‹ Upload scan results as artifact
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: mobsf-security-results
          path: mobsf-results.sarif
          retention-days: 30

  codeql:
    name: ğŸ›¡ï¸ CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ›¡ï¸ Initialise CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java-kotlin
          queries: security-extended

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: codeql-analysis

  # =============================================================================
  # BUILD PHASE - Only runs on main branch pushes
  # =============================================================================
  
  build:
    name: ğŸ¤– Build Android
    needs: [lint, unit-test, security-scan, codeql]
    runs-on: ubuntu-latest
    # Build on all pushes and PRs (but not scheduled runs)
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    outputs:
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: â˜• Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ—ï¸ Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”§ Create .env file with API key
        run: |
          echo "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}" > .env

      - name: ğŸ“‹ Extract version info
        id: version
        run: |
          # Extract version from pubspec and strip trailing .0 (e.g., "1.0.0" -> "1.0")
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          BASE_VERSION=$(echo "$PUBSPEC_VERSION" | sed 's/\.0$//')
          # Offset ensures version codes continue above historical max (was 293)
          VERSION_CODE=$((200 + GITHUB_RUN_NUMBER))
          VERSION_NAME="${BASE_VERSION}.${VERSION_CODE}"
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "ğŸ“± Version: $VERSION_NAME (Code: $VERSION_CODE)"

      - name: ğŸ”‘ Setup Android signing
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > android/app/keystore.jks
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=keystore.jks" >> android/key.properties

      - name: ğŸ“± Build release AAB
        env:
          JAVA_OPTS: -Xmx4g -XX:MaxMetaspaceSize=512m
          GRADLE_OPTS: -Xmx4g -XX:MaxMetaspaceSize=512m -Dorg.gradle.daemon=false
        run: |
          flutter build appbundle --release \
            --build-name=${{ steps.version.outputs.version_name }} \
            --build-number=${{ steps.version.outputs.version_code }}

      - name: ğŸ“¤ Upload AAB artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-aab-${{ steps.version.outputs.version_name }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  build-ios:
    name: ğŸ Build iOS
    needs: [lint, unit-test, security-scan, codeql]
    runs-on: macos-latest
    # Only build iOS on main branch pushes to conserve macOS runner minutes
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”§ Create .env file
        run: |
          echo "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}" > .env

      - name: ğŸ Build iOS (no signing)
        run: flutter build ios --release --no-codesign

      - name: ğŸ“¤ Upload iOS build artifact
        uses: actions/upload-artifact@v6
        with:
          name: ios-build-${{ github.run_number }}
          path: build/ios/iphoneos/Runner.app
          retention-days: 7

  # =============================================================================
  # DEPLOY PHASE - Only runs after successful build on main
  # =============================================================================
  
  deploy:
    name: ğŸš€ Deploy to Play Store
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ“¥ Download AAB artifact
        uses: actions/download-artifact@v7
        with:
          name: release-aab-${{ needs.build.outputs.version_name }}
          path: build/app/outputs/bundle/release/

      - name: ğŸ” Verify AAB and version info
        run: |
          echo "ğŸ“± Deploying version: ${{ needs.build.outputs.version_name }}"
          echo "ğŸ”¢ Version code: ${{ needs.build.outputs.version_code }}"
          echo "ğŸ“¦ AAB file:"
          ls -la build/app/outputs/bundle/release/
          
          if [ ! -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "âŒ AAB file not found!"
            exit 1
          fi
          
          AAB_SIZE=$(stat -c%s build/app/outputs/bundle/release/app-release.aab)
          echo "ğŸ“¦ AAB size: ${AAB_SIZE} bytes"
          if [ $AAB_SIZE -lt 1000000 ]; then
            echo "âš ï¸ Warning: AAB file seems small (< 1MB)"
          fi

      - name: ğŸš€ Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.PACKAGE_NAME }}
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: draft
          inAppUpdatePriority: 2
          releaseName: ${{ needs.build.outputs.version_name }}
